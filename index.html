<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY 39 - æˆ‘çš„39å²æ—¥è®°</title>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* é¢œè‰²å˜é‡ - æŸ”å’Œçš„å¥³æ€§åŒ–è‰²è°ƒ */
        :root {
            --primary-color: #a78bfa; /* æŸ”å’Œçš„è–°è¡£è‰ç´« */
            --secondary-color: #f7b7a3; /* æ¸©æš–çš„èœœæ¡ƒè‰² */
            --bg-color: #fcf8f7; /* ææµ…çš„ç±³ç™½ */
            --card-bg: #ffffff;
            --text-color: #4a4a4a; /* æ·±ç°ï¼Œæ¯”çº¯é»‘æ›´æŸ”å’Œ */
            --border-color: #e0e0e0; /* æµ…ç°è¾¹æ¡† */
            --danger-color: #e77f7f; /* æŸ”å’Œçš„çº¢ */
            --success-color: #8bc34a; /* æŸ”å’Œçš„ç»¿ */
            --hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* æ‚¬åœé˜´å½± */
        }
        body {
            font-family: 'Open Sans', sans-serif; /* ä¸»ä½“æ–‡å­—ä½¿ç”¨ç°ä»£æ— è¡¬çº¿å­—ä½“ */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œæå‡é˜…è¯»èˆ’é€‚åº¦ */
            -webkit-font-smoothing: antialiased; /* å­—ä½“æŠ—é”¯é½¿ï¼Œæ›´å¹³æ»‘ */
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 15px; /* æ›´åœ†æ¶¦çš„è¾¹è§’ */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); /* æ›´æ˜æ˜¾çš„æŸ”å’Œé˜´å½± */
        }
        h1, h2 {
            font-family: 'Playfair Display', serif; /* æ ‡é¢˜ä½¿ç”¨ä¼˜é›…çš„è¡¬çº¿å­—ä½“ */
            color: var(--primary-color);
            text-align: center;
            border-bottom: 1px solid var(--border-color); /* æ›´ç»†çš„åˆ†å‰²çº¿ */
            padding-bottom: 15px;
            margin-top: 0;
            letter-spacing: 0.05em; /* å¢åŠ å­—æ¯é—´è·ï¼Œæå‡ä¼˜é›…æ„Ÿ */
        }
        h1 span {
            margin-left: 10px;
            color: var(--secondary-color); /* å¼ºè°ƒè‰² */
        }
        .birthday-setup {
            background-color: #fff9e6; /* æŸ”å’Œçš„ç±³é»„è‰²èƒŒæ™¯ */
            border: 1px solid #ffe0b2; /* æŸ”å’Œçš„è¾¹æ¡† */
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            color: #6a5a4a; /* æ­é…èƒŒæ™¯çš„æ·±è‰²æ–‡å­— */
        }
        #diary-form fieldset {
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 10px; /* åœ†æ¶¦çš„è¾¹è§’ */
            margin-bottom: 25px;
        }
        #diary-form legend {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            color: var(--primary-color);
            padding: 0 15px;
            font-size: 1.3em;
            letter-spacing: 0.03em;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px; /* å¢åŠ é—´è· */
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        input[type="date"], input[type="text"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* åœ†æ¶¦çš„è¾“å…¥æ¡† */
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fdfdfd;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="date"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2); /* æŸ”å’Œçš„ç„¦ç‚¹é˜´å½± */
            outline: none;
        }
        textarea {
            min-height: 120px; /* å¢åŠ æ–‡æœ¬åŸŸé«˜åº¦ */
            resize: vertical;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px; /* åœ†æ¶¦çš„æŒ‰é’® */
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s ease; /* æ›´å¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* æŒ‰é’®çš„è½»å¾®é˜´å½± */
        }
        button:hover {
            transform: translateY(-2px); /* æ‚¬åœæ—¶è½»å¾®ä¸Šæµ® */
            box-shadow: var(--hover-shadow);
        }
        .btn-save { background-color: var(--success-color); color: white; }
        .btn-save:hover { background-color: #7cb342; } /* ç¨æ·±ä¸€ç‚¹çš„æ‚¬åœè‰² */
        .btn-new { background-color: var(--primary-color); color: white; }
        .btn-new:hover { background-color: #9370db; }
        .btn-export { background-color: var(--secondary-color); color: white; }
        .btn-export:hover { background-color: #f0a08a; }
        .btn-details { background-color: #81d4fa; color: white; } /* æŸ”å’Œçš„è“è‰² */
        .btn-details:hover { background-color: #64b5f6; }
        .btn-edit { background-color: #ffd54f; color: var(--text-color); } /* æŸ”å’Œçš„é»„è‰² */
        .btn-edit:hover { background-color: #ffc107; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-delete:hover { background-color: #d32f2f; }

        #entries-list {
            margin-top: 40px;
        }
        .entry-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 6px solid var(--primary-color); /* æ›´æ˜æ˜¾çš„å·¦ä¾§å¼ºè°ƒè‰² */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); /* æŸ”å’Œçš„å¡ç‰‡é˜´å½± */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .entry-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .entry-info {
            flex-grow: 1;
            font-size: 1.1rem;
        }
        .entry-info strong {
            font-family: 'Playfair Display', serif; /* æ—¥æœŸä¹Ÿä½¿ç”¨è¡¬çº¿å­—ä½“ */
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        .entry-info span {
            margin-left: 20px;
            color: #6c757d;
        }
        .entry-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-shrink: 0;
        }
        .entry-actions button {
            padding: 8px 15px;
            font-size: 0.95rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* ç¨æµ…çš„èƒŒæ™¯é®ç½© */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 8% auto; /* å¼¹çª—ä½ç½®ç¨é«˜ */
            padding: 30px;
            border: none;
            width: 85%;
            max-width: 750px;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 32px; /* æ›´å¤§çš„å…³é—­æŒ‰é’® */
            font-weight: normal; /* å­—ä½“æ›´æŸ”å’Œ */
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover, .close-button:focus {
            color: var(--primary-color);
            text-decoration: none;
        }
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h3 {
            font-family: 'Playfair Display', serif;
            margin: 0 0 8px 0;
            color: var(--primary-color);
            border-bottom: 1px dashed var(--border-color); /* è™šçº¿åˆ†å‰²ï¼Œæ›´æŸ”å’Œ */
            padding-bottom: 8px;
            font-size: 1.2em;
        }
        .detail-section p {
            margin: 0;
            color: #5a5a5a;
        }
        hr {
            border: none;
            border-top: 1px dashed var(--border-color); /* è™šçº¿åˆ†å‰²çº¿ */
            margin: 40px 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            .entry-card { flex-direction: column; align-items: flex-start; }
            .entry-info { margin-bottom: 15px; }
            .entry-info span { margin-left: 0; display: block; margin-top: 5px; }
            .entry-actions { width: 100%; justify-content: flex-end; margin-top: 15px; }
            .modal-content { margin: 5% auto; width: 90%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>MY 39 <span>âœ¨</span> æˆ‘çš„39å²æ—¥è®°</h1>

        <div class="birthday-setup">
            <label for="birthday"><b>ç¬¬ä¸€æ­¥ï¼šè®¾ç½®ä½ çš„39å²ç”Ÿæ—¥æ—¥æœŸ</b></label>
            <input type="date" id="birthday" style="max-width: 220px; margin: 12px auto; display: block;">
            <small>è®¾ç½®åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—â€œ39å²çš„ç¬¬å‡ å¤©â€</small>
        </div>

        <form id="diary-form">
            <input type="hidden" id="entry-id">
            <fieldset>
                <legend>ä»Šæ—¥é€Ÿè§ˆ</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="day-of-39">39å²çš„ç¬¬å‡ å¤©</label>
                        <input type="text" id="day-of-39" readonly style="background-color: #f0f0f0; color: #666;">
                    </div>
                    <div class="form-group">
                        <label for="weather">å¤©æ°”</label>
                        <input type="text" id="weather" placeholder="å¦‚ï¼šæ™´è½¬å¤šäº‘ï¼Œå¾®é£">
                    </div>
                    <div class="form-group">
                        <label for="mood">å¿ƒæƒ…</label>
                        <select id="mood">
                            <option value="ğŸ˜Š æ„‰æ‚¦">ğŸ˜Š æ„‰æ‚¦</option>
                            <option value="ğŸ˜Œ å¹³é™">ğŸ˜Œ å¹³é™</option>
                            <option value="ğŸ˜” éš¾è¿‡">ğŸ˜” éš¾è¿‡</option>
                            <option value="ğŸ˜¤ çƒ¦èº">ğŸ˜¤ çƒ¦èº</option>
                            <option value="ğŸ˜´ ç–²æƒ«">ğŸ˜´ ç–²æƒ«</option>
                            <option value="âœ¨ å…´å¥‹">âœ¨ å…´å¥‹</option>
                            <option value="ğŸ’­ æ²‰æ€">ğŸ’­ æ²‰æ€</option>
                            <option value="ğŸ’– å¹¸ç¦">ğŸ’– å¹¸ç¦</option>
                            <option value="ğŸŒ± æˆé•¿">ğŸŒ± æˆé•¿</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>æ¯æ—¥è®°å½•</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="sleep">ç¡çœ </label>
                        <textarea id="sleep" placeholder="æ˜¨æ™šç¡å¾—å¥½å—ï¼Ÿå‡ ç‚¹å…¥ç¡ï¼Œå‡ ç‚¹é†’æ¥ï¼Ÿæ¢¦å¢ƒå¦‚ä½•ï¼Ÿ"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="exercise">è¿åŠ¨</label>
                        <textarea id="exercise" placeholder="ä»Šå¤©åšäº†ä»€ä¹ˆè¿åŠ¨ï¼Ÿèº«ä½“æ„Ÿè§‰å¦‚ä½•ï¼Ÿ"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="mind">ç²¾ç¥æ»‹å…» (è¯»ä¹¦/æ’­å®¢/éŸ³ä¹/å¨±ä¹)</label>
                        <textarea id="mind" placeholder="è¯»äº†ä»€ä¹ˆä¹¦ï¼Ÿå¬äº†ä»€ä¹ˆæ’­å®¢ï¼Ÿçœ‹äº†ä»€ä¹ˆç”µå½±/å‰§ï¼Ÿæœ‰ä»€ä¹ˆå¯å‘ï¼Ÿ"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="food">ç¾é£Ÿä¸å‘³è•¾</label>
                        <textarea id="food" placeholder="ä»Šå¤©åƒäº†ä»€ä¹ˆç‰¹åˆ«çš„ç¾é£Ÿï¼Ÿæ„Ÿå—å¦‚ä½•ï¼Ÿ"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="work">å·¥ä½œä¸æˆå°±</label>
                        <textarea id="work" placeholder="å·¥ä½œä¸Šçš„è¿›å±•ã€æŒ‘æˆ˜æˆ–æ–°çš„æ€è€ƒã€‚"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="kids">å­©å­ä¸å®¶åº­</label>
                        <textarea id="kids" placeholder="å…³äºå­©å­çš„è¶£äº‹ã€æˆé•¿ç¬é—´æˆ–å®¶åº­äº’åŠ¨ã€‚"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">æ¯æ—¥éšç¬” (æ„Ÿæ‚Ÿä¸å°ç¡®å¹¸)</label>
                        <textarea id="notes" placeholder="è®°å½•ä»»ä½•å…¶ä»–æƒ³è¯´çš„è¯ï¼Œä½ çš„å°ç¡®å¹¸ã€æ„Ÿæ‚Ÿã€çµæ„Ÿæˆ–çƒ¦æ¼ã€‚"></textarea>
                    </div>
                </div>
            </fieldset>

            <div class="button-group">
                <button type="submit" class="btn-save">ä¿å­˜ä»Šæ—¥æ—¥è®°</button>
                <button type="button" id="new-entry-btn" class="btn-new">æ¸…ç©ºå¹¶å¼€å§‹æ–°æ—¥è®°</button>
            </div>
        </form>

        <hr>

        <h2>æˆ‘çš„æ—¥è®°æ—¶å…‰è½´</h2>
        <div style="text-align: center; margin-bottom: 25px;">
            <button id="export-btn" class="btn-export">å¯¼å‡ºæ‰€æœ‰æ—¥è®°åˆ° Excel (CSV)</button>
        </div>
        <div id="entries-list">
            <!-- æ—¥è®°æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('diary-form');
        const entryIdInput = document.getElementById('entry-id');
        const dateInput = document.getElementById('date');
        const dayOf39Input = document.getElementById('day-of-39');
        const weatherInput = document.getElementById('weather');
        const moodInput = document.getElementById('mood');
        const sleepInput = document.getElementById('sleep');
        const exerciseInput = document.getElementById('exercise');
        const mindInput = document.getElementById('mind');
        const foodInput = document.getElementById('food');
        const workInput = document.getElementById('work');
        const kidsInput = document.getElementById('kids');
        const notesInput = document.getElementById('notes');
        const newEntryBtn = document.getElementById('new-entry-btn');
        const entriesList = document.getElementById('entries-list');
        const exportBtn = document.getElementById('export-btn');
        const birthdayInput = document.getElementById('birthday');
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.close-button');

        const STORAGE_KEY = 'my39DiaryEntriesElegant'; // æ›´æ”¹å­˜å‚¨é”®ï¼Œé¿å…ä¸æ—§ç‰ˆæœ¬å†²çª
        const BIRTHDAY_KEY = 'my39BirthdayElegant'; // æ›´æ”¹å­˜å‚¨é”®

        // åˆå§‹åŒ–
        loadBirthday();
        setTodaysDate();
        renderEntries();

        // --- äº‹ä»¶ç›‘å¬ ---
        form.addEventListener('submit', saveEntry);
        newEntryBtn.addEventListener('click', clearForm);
        entriesList.addEventListener('click', handleEntryAction);
        exportBtn.addEventListener('click', exportToCSV);
        birthdayInput.addEventListener('change', saveAndCalculateBirthday);
        dateInput.addEventListener('change', calculateDayNumber);
        closeButton.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // --- åŠŸèƒ½å‡½æ•° ---
        function getEntries() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        }

        function saveEntries(entries) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        }
        
        function loadBirthday() {
            const savedBirthday = localStorage.getItem(BIRTHDAY_KEY);
            if (savedBirthday) {
                birthdayInput.value = savedBirthday;
            }
        }

        function saveAndCalculateBirthday() {
            if (birthdayInput.value) {
                localStorage.setItem(BIRTHDAY_KEY, birthdayInput.value);
                calculateDayNumber();
            }
        }

        function calculateDayNumber() {
            const birthdayStr = localStorage.getItem(BIRTHDAY_KEY);
            const entryDateStr = dateInput.value;
            if (birthdayStr && entryDateStr) {
                const birthday = new Date(birthdayStr);
                const entryDate = new Date(entryDateStr);
                // è®¡ç®—å¤©æ•°å·®ï¼Œ+1 æ˜¯å› ä¸ºå½“å¤©ä¹Ÿç®—ä¸€å¤©
                const diffTime = entryDate.getTime() - birthday.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                dayOf39Input.value = diffDays > 0 ? diffDays : 'è¯·è®¾ç½®39å²ç”Ÿæ—¥';
            } else {
                dayOf39Input.value = 'è¯·è®¾ç½®39å²ç”Ÿæ—¥';
            }
        }

        function setTodaysDate() {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            calculateDayNumber();
        }

        function saveEntry(e) {
            e.preventDefault();
            const entryId = entryIdInput.value;
            const entry = {
                id: entryId ? parseInt(entryId) : Date.now(),
                date: dateInput.value,
                dayOf39: dayOf39Input.value,
                weather: weatherInput.value,
                mood: moodInput.value,
                sleep: sleepInput.value,
                exercise: exerciseInput.value,
                mind: mindInput.value,
                food: foodInput.value,
                work: workInput.value,
                kids: kidsInput.value,
                notes: notesInput.value,
            };

            let entries = getEntries();
            if (entryId) { // æ›´æ–°
                entries = entries.map(e => e.id === entry.id ? entry : e);
            } else { // æ–°å¢
                entries.push(entry);
            }
            saveEntries(entries);
            renderEntries();
            clearForm();
            alert('æ—¥è®°å·²ä¿å­˜ï¼');
        }

        function renderEntries() {
            const entries = getEntries().sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸå€’åº
            entriesList.innerHTML = '';
            if (entries.length === 0) {
                entriesList.innerHTML = '<p style="text-align:center; color:#6c757d; padding: 20px;">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ç¯‡å§ï¼</p>';
                return;
            }
            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                card.dataset.id = entry.id;
                card.innerHTML = `
                    <div class="entry-info">
                        <strong>${entry.date}</strong>
                        <span>${entry.mood}</span>
                        <span>å¤©æ°”: ${entry.weather || 'æœªè®°å½•'}</span>
                        <span>ç¬¬ ${entry.dayOf39 || '?'} å¤©</span>
                    </div>
                    <div class="entry-actions">
                        <button class="btn-details">è¯¦æƒ…</button>
                        <button class="btn-edit">ä¿®æ”¹</button>
                        <button class="btn-delete">åˆ é™¤</button>
                    </div>
                `;
                entriesList.appendChild(card);
            });
        }

        function handleEntryAction(e) {
            const card = e.target.closest('.entry-card');
            if (!card) return;
            const id = parseInt(card.dataset.id);

            if (e.target.classList.contains('btn-details')) {
                showDetails(id);
            } else if (e.target.classList.contains('btn-edit')) {
                loadEntryForEdit(id);
            } else if (e.target.classList.contains('btn-delete')) {
                deleteEntry(id);
            }
        }

        function showDetails(id) {
            const entries = getEntries();
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            modalBody.innerHTML = `
                <h2>${entry.date} - ${entry.mood}</h2>
                <p><strong>å¤©æ°”:</strong> ${entry.weather || 'æœªè®°å½•'} | <strong>39å²çš„ç¬¬ ${entry.dayOf39 || '?'} å¤©</strong></p>
                <div class="detail-section"><h3>ç¡çœ </h3><p>${entry.sleep.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>è¿åŠ¨</h3><p>${entry.exercise.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>ç²¾ç¥æ»‹å…»</h3><p>${entry.mind.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>ç¾é£Ÿä¸å‘³è•¾</h3><p>${entry.food.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>å·¥ä½œä¸æˆå°±</h3><p>${entry.work.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>å­©å­ä¸å®¶åº­</h3><p>${entry.kids.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
                <div class="detail-section"><h3>æ¯æ—¥éšç¬”</h3><p>${entry.notes.replace(/\n/g, '<br>') || 'æœªè®°å½•'}</p></div>
            `;
            modal.style.display = 'block';
        }

        function loadEntryForEdit(id) {
            const entries = getEntries();
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            entryIdInput.value = entry.id;
            dateInput.value = entry.date;
            dayOf39Input.value = entry.dayOf39;
            weatherInput.value = entry.weather;
            moodInput.value = entry.mood;
            sleepInput.value = entry.sleep;
            exerciseInput.value = entry.exercise;
            mindInput.value = entry.mind;
            foodInput.value = entry.food;
            workInput.value = entry.work;
            kidsInput.value = entry.kids;
            notesInput.value = entry.notes;

            window.scrollTo(0, 0); // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.querySelector('#diary-form legend').scrollIntoView({ behavior: 'smooth' }); // å¹³æ»‘æ»šåŠ¨åˆ°è¡¨å•
        }

        function deleteEntry(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                let entries = getEntries();
                entries = entries.filter(e => e.id !== id);
                saveEntries(entries);
                renderEntries();
                alert('æ—¥è®°å·²åˆ é™¤ã€‚');
            }
        }

        function clearForm() {
            form.reset();
            entryIdInput.value = '';
            setTodaysDate(); // æ¸…ç©ºåé‡æ–°è®¾ç½®ä»Šå¤©çš„æ—¥æœŸå’Œå¤©æ•°
        }

        function exportToCSV() {
            const entries = getEntries();
            if (entries.length === 0) {
                alert('æ²¡æœ‰æ—¥è®°å¯ä»¥å¯¼å‡ºã€‚');
                return;
            }

            const headers = ['ID', 'æ—¥æœŸ', '39å²çš„ç¬¬å‡ å¤©', 'å¤©æ°”', 'å¿ƒæƒ…', 'ç¡çœ ', 'è¿åŠ¨', 'ç²¾ç¥æ»‹å…»', 'ç¾é£Ÿä¸å‘³è•¾', 'å·¥ä½œä¸æˆå°±', 'å­©å­ä¸å®¶åº­', 'æ¯æ—¥éšç¬”'];
            const csvRows = [headers.join(',')];

            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str).replace(/\n/g, ' '); // æ›¿æ¢æ¢è¡Œç¬¦ï¼Œé¿å…CSVæ ¼å¼é—®é¢˜
                // å¦‚æœå­—æ®µåŒ…å«é€—å·ã€åŒå¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œåˆ™ç”¨åŒå¼•å·æ‹¬èµ·æ¥
                if (str.includes(',') || str.includes('"')) {
                    // å°†å­—æ®µå†…çš„åŒå¼•å·æ›¿æ¢ä¸ºä¸¤ä¸ªåŒå¼•å·
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            entries.forEach(entry => {
                const row = [
                    entry.id,
                    entry.date,
                    entry.dayOf39,
                    entry.weather,
                    entry.mood,
                    entry.sleep,
                    entry.exercise,
                    entry.mind,
                    entry.food,
                    entry.work,
                    entry.kids,
                    entry.notes
                ].map(escapeCSV);
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' }); // æ·»åŠ  BOM ä»¥æ”¯æŒä¸­æ–‡
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `MY39_æ—¥è®°å¤‡ä»½_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('æ—¥è®°å·²æˆåŠŸå¯¼å‡ºï¼');
        }
    });
    </script>
</body>
</html>
