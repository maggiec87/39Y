<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY39 v2.3 (å·²è°ƒæ•´æ ¼å¼)</title>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ html2canvas åº“ç”¨äºç”Ÿæˆå›¾ç‰‡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ä¸é¢œè‰²å˜é‡ --- */
        :root {
            --primary-color: #a78bfa; --secondary-color: #f7b7a3; --bg-color: #fcf8f7;
            --card-bg: #ffffff; --text-color: #4a4a4a; --border-color: #e0e0e0;
            --danger-color: #e77f7f; --success-color: #8bc34a; --hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: 'Open Sans', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 20px; line-height: 1.7;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background-color: var(--card-bg);
            padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        h1, h2, legend { font-family: 'Playfair Display', serif; color: var(--primary-color); }
        h1 { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 0; letter-spacing: 0.05em; }
        h1 span { margin-left: 10px; color: var(--secondary-color); }
        hr { border: none; border-top: 1px dashed var(--border-color); margin: 40px 0; }
        .hidden { display: none !important; }
        
        /* --- ç”Ÿæ—¥è®¾ç½®ä¸æ˜¾ç¤º --- */
        #birthday-display { text-align: center; margin-bottom: 20px; color: #6c757d; }
        #birthday-display a { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        .birthday-setup { background-color: #fff9e6; border: 1px solid #ffe0b2; padding: 18px; border-radius: 10px; margin-bottom: 25px; text-align: center; }

        /* --- è¡¨å•ä¸è¾“å…¥å…ƒç´  --- */
        #diary-form fieldset { border: 1px solid var(--border-color); padding: 25px; border-radius: 10px; margin-bottom: 25px; }
        #diary-form legend { font-weight: 700; padding: 0 15px; font-size: 1.3em; letter-spacing: 0.03em; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; }
        input[type="date"], input[type="text"], input[type="time"], input[type="number"], select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;
            box-sizing: border-box; background-color: #fdfdfd; transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2); outline: none; }
        textarea { min-height: 100px; resize: vertical; }
        .full-width { grid-column: 1 / -1; }
        
        /* --- ç‰¹å®šæ¨¡å—æ ·å¼ --- */
        #mood-custom { margin-top: 10px; }
        .sleep-quality-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .sleep-quality-btn { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s ease; user-select: none; }
        .sleep-quality-btn:hover { background-color: #f0f0f0; }
        .sleep-quality-btn.selected { border-color: var(--primary-color); background-color: #f3e8ff; box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3); }
        .sleep-time-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #sleep-duration-display { font-weight: bold; color: var(--primary-color); }
        
        .exercise-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .exercise-item label { margin-bottom: 0; flex-shrink: 0; width: 60px; }
        .exercise-item input[type="checkbox"] { width: auto; }
        .exercise-duration { font-size: 0.9em; padding: 8px; }
        .exercise-other-group { display: flex; align-items: center; gap: 10px; margin-top: 10px; }

        .sub-group { margin-top: 15px; }
        .sub-group label { font-size: 0.9em; color: #555; }
        .sub-group textarea { min-height: 60px; }

        /* --- æŒ‰é’® (å·²æŒ‰è¦æ±‚è°ƒæ•´) --- */
        .button-group { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; font-size: 1.05rem; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        button:hover { transform: translateY(-2px); box-shadow: var(--hover-shadow); }

        /* 3. Save/Refresh ä½¿ç”¨æ¸©å’Œé¢œè‰² */
        .btn-save { background-color: #81c784; color: white; } /* æ¸©å’Œçš„ç»¿è‰² */
        .btn-save:hover { background-color: #66bb6a; }
        .btn-new { background-color: #4db6ac; color: white; } /* æ¸©å’Œçš„é’è‰² */
        .btn-new:hover { background-color: #26a69a; }
        
        /* 1. å¯¼å‡ºæŒ‰é’®ä½¿ç”¨ç°è‰² */
        .btn-export { background-color: #9e9e9e; color: white; } /* ç°è‰² */
        .btn-export:hover { background-color: #8c8c8c; }
        
        .export-button-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        
        /* --- æ—¥è®°åˆ—è¡¨ (å·²æŒ‰è¦æ±‚è°ƒæ•´) --- */
        #entries-list { margin-top: 40px; }
        .entry-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-left: 6px solid var(--primary-color);
            padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; transition: all 0.2s ease;
        }
        .entry-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .entry-info { flex-grow: 1; }
        .entry-info strong { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--primary-color); }
        .entry-info .day-tag { background-color: var(--secondary-color); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.9rem; font-weight: bold; margin-left: 15px; }
        .entry-info span { margin-left: 15px; color: #6c757d; }
        .entry-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        /* 2. View/Edit/Delete ä½¿ç”¨ä¸åŒé¢œè‰² */
        .entry-actions button {
            padding: 8px 15px;
            font-size: 0.95rem;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .entry-actions button:hover {
            transform: translateY(-1px);
        }
        .entry-actions .btn-details { background-color: #64b5f6; } /* View - Blue */
        .entry-actions .btn-edit    { background-color: #ffb74d; } /* Edit - Orange */
        .entry-actions .btn-delete  { background-color: #e57373; } /* Delete - Red */

        .entry-actions .btn-details:hover { background-color: #42a5f5; }
        .entry-actions .btn-edit:hover    { background-color: #ffa726; }
        .entry-actions .btn-delete:hover  { background-color: #ef5350; }

        /* --- å¼¹çª— (Modal) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 750px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-button { color: #aaa; float: right; font-size: 32px; font-weight: normal; cursor: pointer; line-height: 1; }
        .close-button:hover { color: var(--primary-color); }
        .detail-section h3 { font-family: 'Playfair Display', serif; margin: 15px 0 8px 0; color: var(--primary-color); border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; font-size: 1.2em; }
        .detail-section h4 { font-family: 'Open Sans', sans-serif; font-size: 1em; color: #555; margin: 10px 0 5px 0; font-weight: 600; }
        .detail-section p, .detail-section ul { margin: 0; color: #5a5a5a; white-space: pre-wrap; }
        .detail-section ul { padding-left: 20px; white-space: normal; }
        #save-image-btn { background-color: var(--secondary-color); color: white; margin-top: 20px; }

        /* --- å›¾ç‰‡å¯¼å‡ºæ¨¡æ¿ (éšè—) --- */
        #image-export-container {
            position: absolute; left: -9999px; top: 0;
            width: 1080px; padding: 60px;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            font-family: 'Open Sans', sans-serif; color: #333; box-sizing: border-box;
        }
        #image-export-container .img-header { text-align: center; margin-bottom: 40px; }
        #image-export-container .img-day { font-family: 'Playfair Display', serif; font-size: 80px; color: var(--primary-color); }
        #image-export-container .img-date { font-size: 24px; color: #777; margin-top: 10px; }
        #image-export-container .img-section { margin-bottom: 30px; }
        #image-export-container .img-section h4 { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--secondary-color); margin: 0 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        #image-export-container .img-section p { font-size: 20px; line-height: 1.6; white-space: pre-wrap; }
        #image-export-container .img-footer { text-align: center; margin-top: 50px; font-size: 16px; color: #999; }

        /* --- é¡µè„š --- */
        .footer-note { text-align: center; margin-top: 40px; font-size: 0.85em; color: #999; }
    </style>
</head>
<body>

    <div class="container">
        <h1><span>âœ¨</span>MY39</h1>

        <div id="birthday-display" class="hidden">
            39th Birthday: <span id="birthday-text"></span> (<a id="edit-birthday-link">ä¿®æ”¹</a>)
        </div>

        <div id="birthday-setup" class="birthday-setup">
            <label for="birthday"><b>é¦–æ¬¡è®°å½•è¾“å…¥39Y Birthday</b></label>
            <input type="date" id="birthday" style="max-width: 220px; margin: 12px auto; display: block;">
            <button id="save-birthday-btn" class="btn-new" style="padding: 8px 16px; font-size: 0.9em;">ç¡®è®¤</button>
        </div>

        <form id="diary-form">
            <input type="hidden" id="entry-id">
            <fieldset>
                <legend>BASIC</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
   <div class="form-group">
                        <label for="day-of-39">Day</label>
                        <input type="text" id="day-of-39" readonly style="background-color: #f0f0f0; color: #666; text-align: center; font-weight: bold; font-size: 1.2em;">
                    </div>
                    <div class="form-group">
                        <label for="weather">Weather</label>
                        <input type="text" id="weather" placeholder="Sun Cloud Rain Breeze">
                    </div>
                    <div class="form-group">
                        <label for="mood">Mood</label>
                        <select id="mood">
                            <option value="ğŸ˜Š æ„‰æ‚¦">ğŸ˜Š</option> <option value="ğŸ˜Œ å¹³é™">ğŸ˜Œ</option>
                            <option value="ğŸ˜” éš¾è¿‡">ğŸ˜”</option> <option value="ğŸ˜¤ çƒ¦èº">ğŸ˜¤</option>
                            <option value="ğŸ˜´ ç–²æƒ«">ğŸ˜´</option> <option value="âœ¨ å…´å¥‹">âœ¨</option>
                            <option value="ğŸ’­ æ²‰æ€">ğŸ’­</option> <option value="ğŸ’– å¹¸ç¦">ğŸ’–</option>
                            <option value="ğŸŒ± æˆé•¿">ğŸŒ±</option> <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="text" id="mood-custom" class="hidden" placeholder="æè¿°ä½ çš„å¿ƒæƒ…çŠ¶æ€">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>DIARY</legend>
                <div class="form-grid">
                    <!-- ç¡çœ æ¨¡å— -->
                    <div class="form-group">
                        <label>SLEEP</label>
                        <div class="sleep-quality-group">
                            <span class="sleep-quality-btn" data-value="ğŸ˜´ æ·±åº¦ç¡çœ ">ğŸ˜´Good</span>
                            <span class="sleep-quality-btn" data-value="ğŸ˜Œ æ­£å¸¸ç¡çœ ">ğŸ˜ŒNice</span>
                            <span class="sleep-quality-btn" data-value="ğŸ˜ æµ…åº¦ç¡çœ ">ğŸ˜Soso</span>
                            <span class="sleep-quality-btn" data-value="ğŸ˜© ç¡çœ ä¸ä½³">ğŸ˜©Bad</span>
                        </div>
                        <div class="sleep-time-group">
                            <input type="time" id="sleep-start" title="å…¥ç¡æ—¶é—´">
                            <span>-</span>
                            <input type="time" id="sleep-end" title="é†’æ¥æ—¶é—´">
                            <span id="sleep-duration-display">Total: /</span>
                        </div>
                    </div>

                    <!-- è¿åŠ¨æ¨¡å— -->
                    <div class="form-group">
                        <label>SPORT</label>
                        <div id="exercise-group">
                            <div class="exercise-item">
                                <input type="checkbox" name="exercise-type" value="éª‘è½¦" id="ex-bike">
                                <label for="ex-bike">Bike</label>
                                <input type="number" class="exercise-duration" placeholder="Duration" min="0">
                            </div>
                            <div class="exercise-item">
                                <input type="checkbox" name="exercise-type" value="è·‘æ­¥" id="ex-run">
                                <label for="ex-run">Run</label>
                                <input type="number" class="exercise-duration" placeholder="Duration" min="0">
                            </div>
                            <div class="exercise-item">
                                <input type="checkbox" name="exercise-type" value="èµ°è·¯" id="ex-walk">
                                <label for="ex-walk">Walk</label>
                                <input type="number" class="exercise-duration" placeholder="Duration" min="0">
    </div>
                            <div class="exercise-item">
                                <input type="checkbox" name="exercise-type" value="è·³ç»³" id="ex-rope">
                                <label for="ex-rope">Jump</label>
                                <input type="number" class="exercise-duration" placeholder="Duration" min="0">
                            </div>
                            <div class="exercise-item">
                                <input type="checkbox" name="exercise-type" value="ç‘œä¼½" id="ex-yoga">
                                <label for="ex-yoga">Yoga</label>
                                <input type="number" class="exercise-duration" placeholder="Duration" min="0">
                            </div>
                            <div class="exercise-other-group">
                                <input type="text" id="exercise-other-name" placeholder="Else..." style="flex-grow: 1;">
                                <input type="number" id="exercise-other-duration" placeholder="Duration" min="0" style="width: 120px;">
                            </div>
                        </div>
                    </div>

                    <!-- ç²¾ç¥æ»‹å…»æ¨¡å— -->
                    <div class="form-group full-width">
                        <label>ENJOY</label>
                        <div class="sub-group">
                            <label for="mind-book">ğŸ“–Book</label>
                            <textarea id="mind-book" placeholder="Thoughts on books"></textarea>
                        </div>
                        <div class="sub-group">
                            <label for="mind-podcast">ğŸ§Podcast</label>
                            <textarea id="mind-podcast" placeholder="Moves and likes"></textarea>
                        </div>
                        <div class="sub-group">
                            <label for="mind-media">ğŸ¬Music/XHS</label>
                            <textarea id="mind-media" placeholder="Songs and videos"></textarea>
                        </div>
                        <div class="sub-group">
                            <label for="mind-creation">âœ¨Creation</label>
                            <textarea id="mind-creation" placeholder="Ideas and pieces"></textarea>
                        </div>
                    </div>

                    <!-- ç¾é£Ÿæ¨¡å— -->
                    <div class="form-group full-width">
                        <label>FOOD</label>
                        <div class="sub-group">
                            <label for="food-main">ğŸšMeals</label>
                            <textarea id="food-main" placeholder="Brunch and Dinner"></textarea>
                        </div>
                        <div class="sub-group">
                            <label for="food-snack">ğŸ°Snacks</label>
                            <textarea id="food-snack" placeholder="Junk food"></textarea>
                        </div>
                         <div class="sub-group">
                            <label for="food-drink">ğŸ¹Drinks</label>
                            <textarea id="food-drink" placeholder="Coffee or Tea"></textarea>
                        </div>
                    </div>

                    <!-- KID and WORK swapped -->
                    <div class="form-group">
                        <label for="kids">KID</label>
                        <textarea id="kids" placeholder="Bitter and Sweet"></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="work">MONEY</label>
                        <textarea id="work" placeholder="BULLSHITJOB"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="notes">MOMENT</label>
    <textarea id="notes" placeholder="Smiles"></textarea>
                    </div>
                </div>
            </fieldset>

            <div class="button-group">
                <button type="submit" class="btn-save">Save</button>
                <button type="button" id="new-entry-btn" class="btn-new">Refresh</button>
            </div>
        </form>

        <hr>

        <h2>TIMELINE</h2>
        <div class="export-button-group">
            <button id="export-txt-btn" class="btn-export">Export.txt</button>
            <button id="export-csv-btn" class="btn-export">Export.csv</button>
        </div>
        <div id="entries-list"></div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-body"></div>
            <button id="save-image-btn">åˆ†äº«</button>
        </div>
    </div>

    <!-- ç”¨äºç”Ÿæˆå›¾ç‰‡çš„éšè—å®¹å™¨ -->
    <div id="image-export-container"></div>
    
    <footer class="footer-note">
        <p><strong>æ•°æ®å®‰å…¨æç¤º</strong>ï¼šæ‰€æœ‰æ—¥è®°æ•°æ®ä»…ä¿å­˜åœ¨æ‚¨å½“å‰çš„æµè§ˆå™¨ä¸­ã€‚ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ä½¿ç”¨æ—¶ï¼Œè¯·å‹¿ç§»åŠ¨æ–‡ä»¶ä½ç½®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ•°æ®æ— æ³•è¯»å–ã€‚</p>
        <p>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€ä½¿ç”¨æ— ç—•æ¨¡å¼æˆ–æ›´æ¢è®¾å¤‡å°†å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å»ºè®®æ‚¨å®šæœŸä½¿ç”¨â€œå¯¼å‡ºâ€åŠŸèƒ½å¤‡ä»½æ‚¨çš„çè´µè®°å½•ã€‚</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM å…ƒç´ è·å– ---
        const form = document.getElementById('diary-form');
        const entryIdInput = document.getElementById('entry-id');
        const dateInput = document.getElementById('date');
        const dayOf39Input = document.getElementById('day-of-39');
        const weatherInput = document.getElementById('weather');
        const moodInput = document.getElementById('mood');
        const moodCustomInput = document.getElementById('mood-custom');
        const sleepQualityBtns = document.querySelectorAll('.sleep-quality-btn');
        const sleepStartInput = document.getElementById('sleep-start');
        const sleepEndInput = document.getElementById('sleep-end');
        const sleepDurationDisplay = document.getElementById('sleep-duration-display');
        
        const exerciseItems = document.querySelectorAll('.exercise-item');
        const exerciseOtherNameInput = document.getElementById('exercise-other-name');
        const exerciseOtherDurationInput = document.getElementById('exercise-other-duration');

        const mindBookInput = document.getElementById('mind-book');
        const mindPodcastInput = document.getElementById('mind-podcast');
        const mindMediaInput = document.getElementById('mind-media');
        const mindCreationInput = document.getElementById('mind-creation');
        const foodMainInput = document.getElementById('food-main');
        const foodSnackInput = document.getElementById('food-snack');
        const foodDrinkInput = document.getElementById('food-drink');
        const workInput = document.getElementById('work');
        const kidsInput = document.getElementById('kids');
        const notesInput = document.getElementById('notes');
        const newEntryBtn = document.getElementById('new-entry-btn');
        const entriesList = document.getElementById('entries-list');
        const exportTxtBtn = document.getElementById('export-txt-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const birthdayInput = document.getElementById('birthday');
        const saveBirthdayBtn = document.getElementById('save-birthday-btn');
        const birthdaySetupDiv = document.getElementById('birthday-setup');
        const birthdayDisplayDiv = document.getElementById('birthday-display');
        const birthdayTextSpan = document.getElementById('birthday-text');
        const editBirthdayLink = document.getElementById('edit-birthday-link');
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const closeButton = document.querySelector('.close-button');
        const saveImageBtn = document.getElementById('save-image-btn');

        const STORAGE_KEY = 'my39DiarySystem_v2.3'; 
        const BIRTHDAY_KEY = 'my39Birthday_v2';
        let currentDetailEntryId = null;

        // --- åˆå§‹åŒ– ---
        updateBirthdayUI();
        setTodaysDate();
        renderEntries();

        // --- äº‹ä»¶ç›‘å¬ ---
        form.addEventListener('submit', saveEntry);
        newEntryBtn.addEventListener('click', clearForm);
        entriesList.addEventListener('click', handleEntryAction);
        exportTxtBtn.addEventListener('click', exportToTxt);
        exportCsvBtn.addEventListener('click', exportToCSV);
        saveBirthdayBtn.addEventListener('click', saveAndCalculateBirthday);
        editBirthdayLink.addEventListener('click', () => {
            birthdaySetupDiv.classList.remove('hidden');
            birthdayDisplayDiv.classList.add('hidden');
        });
        dateInput.addEventListener('change', calculateDayNumber);
        moodInput.addEventListener('change', () => {
            moodCustomInput.classList.toggle('hidden', moodInput.value !== 'custom');
        });
        sleepQualityBtns.forEach(btn => btn.addEventListener('click', (e) => {
            sleepQualityBtns.forEach(b => b.classList.remove('selected'));
            e.currentTarget.classList.add('selected');
        }));
        [sleepStartInput, sleepEndInput].forEach(input => input.addEventListener('change', calculateSleepDuration));
        closeButton.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == modal) modal.style.display = 'none';
        });
        saveImageBtn.addEventListener('click', () => {
            if (currentDetailEntryId) generateImage(currentDetailEntryId);
        });

        // --- åŠŸèƒ½å‡½æ•° ---
        function getEntries() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

        function updateBirthdayUI() {
            const savedBirthday = localStorage.getItem(BIRTHDAY_KEY);
            if (savedBirthday) {
                birthdayInput.value = savedBirthday;
                birthdayTextSpan.textContent = savedBirthday;
                birthdaySetupDiv.classList.add('hidden');
                birthdayDisplayDiv.classList.remove('hidden');
                calculateDayNumber();
            } else {
                birthdaySetupDiv.classList.remove('hidden');
                birthdayDisplayDiv.classList.add('hidden');
            }
        }

        function saveAndCalculateBirthday() {
            if (birthdayInput.value) {
                localStorage.setItem(BIRTHDAY_KEY, birthdayInput.value);
                updateBirthdayUI();
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸã€‚');
            }
        }

        function calculateDayNumber() {
            const birthdayStr = localStorage.getItem(BIRTHDAY_KEY);
            const entryDateStr = dateInput.value;
            if (birthdayStr && entryDateStr) {
                const birthday = new Date(birthdayStr);
                const entryDate = new Date(entryDateStr);
                const diffTime = entryDate.getTime() - birthday.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                dayOf39Input.value = diffDays > 0 ? diffDays : 'N/A';
            } else {
                dayOf39Input.value = 'N/A';
            }
        }

        function calculateSleepDuration() {
            const start = sleepStartInput.value;
            const end = sleepEndInput.value;
            if (!start || !end) {
                sleepDurationDisplay.textContent = 'æ€»ç¡çœ : /';
                return;
            }
            let [startH, startM] = start.split(':').map(Number);
            let [endH, endM] = end.split(':').map(Number);
            
            let startMinutes = startH * 60 + startM;
            let endMinutes = endH * 60 + endM;
            
            let durationMinutes;
            if (endMinutes < startMinutes) { // è·¨å¤©
                durationMinutes = (24 * 60 - startMinutes) + endMinutes;
            } else {
                durationMinutes = endMinutes - startMinutes;
            }
            
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            sleepDurationDisplay.textContent = `æ€»ç¡çœ : ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
        }

        function setTodaysDate() {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            calculateDayNumber();
        }

        function saveEntry(e) {
            e.preventDefault();
            const entryId = entryIdInput.value;

            const exerciseData = [];
            exerciseItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const durationInput = item.querySelector('.exercise-duration');
                if (checkbox.checked) {
                    exerciseData.push({
                        name: checkbox.value,
                        duration: durationInput.value || '0'
                    });
                }
            });
            if (exerciseOtherNameInput.value.trim()) {
                exerciseData.push({
                    name: exerciseOtherNameInput.value.trim(),
                    duration: exerciseOtherDurationInput.value || '0'
                });
            }

            const entry = {
                id: entryId ? parseInt(entryId) : Date.now(),
                date: dateInput.value,
                dayOf39: dayOf39Input.value,
                weather: weatherInput.value,
                mood: moodInput.value === 'custom' ? moodCustomInput.value.trim() : moodInput.value,
                sleep: {
                    quality: document.querySelector('.sleep-quality-btn.selected')?.dataset.value || '',
                    start: sleepStartInput.value,
                    end: sleepEndInput.value,
                    duration: sleepDurationDisplay.textContent
                },
                exercise: exerciseData,
                mind: {
                    book: mindBookInput.value,
                    podcast: mindPodcastInput.value,
                    media: mindMediaInput.value,
                    creation: mindCreationInput.value
                },
                food: {
                    main: foodMainInput.value,
                    snack: foodSnackInput.value,
                    drink: foodDrinkInput.value
                },
                kids: kidsInput.value,
                work: workInput.value,
                notes: notesInput.value,
            };

            let entries = getEntries();
            const existingIndex = entries.findIndex(e => e.id === entry.id);
            if (existingIndex > -1) {
                entries[existingIndex] = entry;
            } else {
                entries.push(entry);
            }
            saveEntries(entries);
            renderEntries();
            clearForm();
            alert('æ—¥è®°å·²ä¿å­˜ï¼');
        }

        function renderEntries() {
            const entries = getEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
            entriesList.innerHTML = '';
            if (entries.length === 0) {
                entriesList.innerHTML = '<p style="text-align:center; color:#6c757d; padding: 20px;">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ç¯‡å§ï¼</p>';
                return;
            }
            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                card.dataset.id = entry.id;
                card.innerHTML = `
                    <div class="entry-info">
                        <strong>${entry.date}</strong>
                        <span class="day-tag">DAY ${entry.dayOf39 || '/'}</span>
                        <span>${entry.mood || '/'}</span>
                    </div>
                    <div class="entry-actions">
                        <button class="btn-details">View</button>
                        <button class="btn-edit">Edit</button>
                        <button class="btn-delete">Delete</button>
                    </div>
                `;
                entriesList.appendChild(card);
            });
        }

        function handleEntryAction(e) {
            const card = e.target.closest('.entry-card');
            if (!card) return;
            const id = parseInt(card.dataset.id);

            if (e.target.classList.contains('btn-details')) showDetails(id);
            else if (e.target.classList.contains('btn-edit')) loadEntryForEdit(id);
            else if (e.target.classList.contains('btn-delete')) deleteEntry(id);
        }
        
        function formatExerciseData(exerciseData) {
            if (!exerciseData || exerciseData.length === 0) {
                return '/';
            }
            if (typeof exerciseData === 'string') {
                return exerciseData;
            }
            return exerciseData.map(ex => `${ex.name}${ex.duration && ex.duration !== '0' ? ` (${ex.duration}åˆ†é’Ÿ)` : ''}`).join(', ');
        }

        function showDetails(id) {
            const entry = getEntries().find(e => e.id === id);
            if (!entry) return;
            currentDetailEntryId = id;

            const p = (text) => text && text.trim() ? `<p>${text.replace(/\n/g, '<br>')}</p>` : '<p>/</p>';
            
            modalBody.innerHTML = `
                <h2>${entry.date} - ${entry.mood || '/'}</h2>
                <p><strong>Weather:</strong> ${entry.weather || '/'} | <strong class="day-tag" style="font-size: 1em; display: inline-block; vertical-align: middle;">DAY ${entry.dayOf39 || '/'}</strong></p>
                
                <div class="detail-section"><h3>SLEEP</h3><p>${entry.sleep?.quality || '/'} (${entry.sleep?.duration || 'æœªè®°å½•æ—¶é•¿'})</p></div>
                
                <div class="detail-section"><h3>SPORT</h3><p>${formatExerciseData(entry.exercise)}</p></div>
                
                <div class="detail-section"><h3>ENJOY</h3>
                    <h4>ğŸ“–Books</h4>${p(entry.mind?.book)}
                    <h4>ğŸ§Podcast</h4>${p(entry.mind?.podcast)}
                    <h4>ğŸ¬Music/XHS</h4>${p(entry.mind?.media)}
                    <h4>âœ¨Creation</h4>${p(entry.mind?.creation)}
                </div>
                
                <div class="detail-section"><h3>FOOD</h3>
                    <h4>ğŸšMeals</h4>${p(entry.food?.main)}
                    <h4>ğŸ°Snacks</h4>${p(entry.food?.snack)}
                    <h4>ğŸ¹Drinks</h4>${p(entry.food?.drink)}
                </div>

                <div class="detail-section"><h3>KID</h3>${p(entry.kids)}</div>
                
                <div class="detail-section"><h3>WORK</h3>${p(entry.work)}</div>

                <div class="detail-section"><h3>MOMENT</h3>${p(entry.notes)}</div>
            `;
            modal.style.display = 'block';
        }

        function loadEntryForEdit(id) {
            const entry = getEntries().find(e => e.id === id);
            if (!entry) return;
            
            clearForm();

            entryIdInput.value = entry.id;
            dateInput.value = entry.date;
            dayOf39Input.value = entry.dayOf39;
            weatherInput.value = entry.weather;
            
            const moodOptions = Array.from(moodInput.options).map(o => o.value);
            if (moodOptions.includes(entry.mood)) {
                moodInput.value = entry.mood;
                moodCustomInput.classList.add('hidden');
            } else {
                moodInput.value = 'custom';
                moodCustomInput.value = entry.mood;
                moodCustomInput.classList.remove('hidden');
            }

            if (entry.sleep) {
                sleepQualityBtns.forEach(btn => btn.classList.toggle('selected', btn.dataset.value === entry.sleep.quality));
                sleepStartInput.value = entry.sleep.start || '';
                sleepEndInput.value = entry.sleep.end || '';
                calculateSleepDuration();
            }

            if (entry.exercise && Array.isArray(entry.exercise)) {
                const otherExercises = [];
                entry.exercise.forEach(ex => {
                    let found = false;
                    exerciseItems.forEach(item => {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        const durationInput = item.querySelector('.exercise-duration');
                        if (checkbox.value === ex.name) {
                            checkbox.checked = true;
                            durationInput.value = ex.duration || '';
                            found = true;
                        }
                    });
                    if (!found) {
                        otherExercises.push(ex);
                    }
                });
                if (otherExercises.length > 0) {
                    exerciseOtherNameInput.value = otherExercises.map(e => e.name).join(', ');
                    exerciseOtherDurationInput.value = otherExercises[0]?.duration || '';
                }
            }

            if(entry.mind) {
                mindBookInput.value = entry.mind.book || '';
                mindPodcastInput.value = entry.mind.podcast || '';
                mindMediaInput.value = entry.mind.media || '';
                mindCreationInput.value = entry.mind.creation || '';
            }
            if(entry.food) {
                foodMainInput.value = entry.food.main || '';
                foodSnackInput.value = entry.food.snack || '';
                foodDrinkInput.value = entry.food.drink || '';
            }

            kidsInput.value = entry.kids || '';
            workInput.value = entry.work || '';
            notesInput.value = entry.notes || '';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteEntry(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                saveEntries(getEntries().filter(e => e.id !== id));
                renderEntries();
                alert('æ—¥è®°å·²åˆ é™¤ã€‚');
            }
        }

        function clearForm() {
            form.reset();
            entryIdInput.value = '';
            moodCustomInput.classList.add('hidden');
            sleepQualityBtns.forEach(b => b.classList.remove('selected'));
            sleepDurationDisplay.textContent = 'æ€»ç¡çœ : /';
            document.querySelectorAll('.exercise-duration').forEach(input => input.value = '');
            setTodaysDate();
        }

        async function generateImage(id) {
            const entry = getEntries().find(e => e.id === id);
            if (!entry) return;

            const section = (title, content) => content && content.trim() && content.trim() !== '/' ? `<div class="img-section"><h4>${title}</h4><p>${content.replace(/\n/g, '<br>')}</p></div>` : '';

            const exportContainer = document.getElementById('image-export-container');
            exportContainer.innerHTML = `
                <div class="img-header">
                    <div class="img-day">DAY ${entry.dayOf39 || '/'}</div>
                    <div class="img-date">${entry.date} &nbsp; | &nbsp; ${entry.mood || '/'}</div>
                </div>
                ${section('é—ªå…‰æ—¶åˆ»', entry.notes)}
                ${section('ç¡çœ ', `${entry.sleep?.quality || ''} (${entry.sleep?.duration || ''})`)}
                ${section('è¿åŠ¨', formatExerciseData(entry.exercise))}
                ${section('å…³äºå­©å­', entry.kids)}
                <div class="img-footer">
                    Generated by MY 39 Personal Growth System
                </div>
            `;
            
            alert('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');

            try {
                const canvas = await html2canvas(exportContainer, { scale: 2 });
                const link = document.createElement('a');
                link.download = `MY39_DAY${entry.dayOf39}_${entry.date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                console.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
                alert('æŠ±æ­‰ï¼Œå›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚');
            }
        }

        function exportToTxt() {
            const entries = getEntries().sort((a, b) => new Date(b.date) - new Date(a.date));
            if (entries.length === 0) {
                alert('æ²¡æœ‰æ—¥è®°å¯ä»¥å¯¼å‡ºã€‚');
                return;
            }

            let fullText = "MY39 æ—¥è®°å¤‡ä»½\n\n";
            const val = (text) => text && text.trim() ? text.trim() : '/';

            entries.forEach(entry => {
                fullText += `========================================\n`;
                fullText += `æ—¥æœŸ: ${entry.date} (DAY ${entry.dayOf39 || 'N/A'})\n`;
                fullText += `å¿ƒæƒ…: ${val(entry.mood)}\n`;
                fullText += `Weather: ${val(entry.weather)}\n`;
                fullText += `----------------------------------------\n`;
                fullText += `SLEEP:\n  ${val(entry.sleep?.quality)} (${val(entry.sleep?.duration)})\n\n`;
                fullText += `SPORTS:\n  ${formatExerciseData(entry.exercise)}\n\n`;
                fullText += `ENJOY:\n`;
                fullText += `  - Books: ${val(entry.mind?.book)}\n`;
                fullText += `  - Podcast: ${val(entry.mind?.podcast)}\n`;
                fullText += `  - Music/XHS: ${val(entry.mind?.media)}\n`;
                fullText += `  - Creation: ${val(entry.mind?.creation)}\n\n`;
                fullText += `FOOD:\n`;
                fullText += `  - Meals: ${val(entry.food?.main)}\n`;
                fullText += `  - Snacks: ${val(entry.food?.snack)}\n`;
                fullText += `  - Drinks: ${val(entry.food?.drink)}\n\n`;
                fullText += `KID:\n  ${val(entry.kids)}\n\n`;
                fullText += `WORK:\n  ${val(entry.work)}\n\n`;
                fullText += `MOMENTS:\n  ${val(entry.notes)}\n\n`;
            });

            const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MY39_æ—¥è®°å¤‡ä»½_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToCSV() {
            const entries = getEntries();
            if (entries.length === 0) {
                alert('æ²¡æœ‰æ—¥è®°å¯ä»¥å¯¼å‡ºã€‚');
                return;
            }

            const headers = ['ID', 'æ—¥æœŸ', 'DAY', 'Weather', 'å¿ƒæƒ…', 'ç¡çœ è´¨é‡', 'å…¥ç¡æ—¶é—´', 'é†’æ¥æ—¶é—´', 'ç¡çœ æ—¶é•¿', 'è¿åŠ¨', 'è¯»ä¹¦', 'æ’­å®¢å¬ä¹¦', 'å½±éŸ³éŸ³ä¹', 'å¥‡æ€å¦™æƒ³', 'ä¸‰é¤', 'é›¶é£Ÿç”œå“', 'é¥®å“', 'å…³äºå­©å­', 'å·¥ä½œæˆå°±', 'é—ªå…‰æ—¶åˆ»'];
            const csvRows = [headers.join(',')];

            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str).replace(/\n/g, ' ');
                if (str.includes(',') || str.includes('"')) {
                    return `"${str.replace(/"/g, '""')}"`;
             }
                return str;
            };

            entries.forEach(entry => {
                const row = [
                    entry.id, entry.date, entry.dayOf39, entry.weather, entry.mood,
                    entry.sleep?.quality, entry.sleep?.start, entry.sleep?.end, entry.sleep?.duration,
                    formatExerciseData(entry.exercise),
                    entry.mind?.book, entry.mind?.podcast, entry.mind?.media, entry.mind?.creation,
                    entry.food?.main, entry.food?.snack, entry.food?.drink,
                    entry.kids, entry.work, entry.notes
                ].map(escapeCSV);
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MY39_æ—¥è®°å¤‡ä»½_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });
    </script>
</body>
</html>
